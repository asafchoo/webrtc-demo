<!DOCTYPE html>
<html>
<head>
    <title>Simple WebRTC via Firebase</title>
    <style>
        video { width: 45%; border: 1px solid #ccc; margin: 10px; }
    </style>
</head>
<body>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <button onclick="startCall()">Start Call</button>
    <input type="text" id="roomId" placeholder="Room ID (share with peer)">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
			  apiKey: "AIzaSyCHlM47ApiJzYumwOrBix1lXQ6A0d42xSQ",
			  authDomain: "goldenspahere.firebaseapp.com",
			  databaseURL: "https://goldenspahere-default-rtdb.firebaseio.com",
			  projectId: "goldenspahere",
			  storageBucket: "goldenspahere.firebasestorage.app",
			  messagingSenderId: "305569434785",
			  appId: "1:305569434785:web:1ba49bdeae65f311e434e0",
			  measurementId: "G-K2ECGHN6CQ"
			};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let pc = new RTCPeerConnection(servers);
        let localStream;
		const roomInput = document.getElementById('roomId');


        pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

        async function init() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }
        
        async function startCall() {
			await init();
			const roomId = roomInput.value;

			const roomRef = db.ref(roomId);
			const callerCandidatesRef = roomRef.child("callerCandidates");

			// Listen for ICE and push to Firebase
			pc.onicecandidate = event => {
				if (event.candidate) {
					callerCandidatesRef.push(JSON.stringify(event.candidate));
				}
		};

		const offer = await pc.createOffer();
		await pc.setLocalDescription(offer);
		await roomRef.child("offer").set(JSON.stringify(offer));

		// Wait for answer
		roomRef.child("answer").on("value", async snapshot => {
			if (snapshot.exists() && !pc.currentRemoteDescription) {
				const answer = JSON.parse(snapshot.val());
				await pc.setRemoteDescription(answer);
			}
		});

		// Handle ICE candidates from callee
		roomRef.child("calleeCandidates").on("child_added", snapshot => {
			const candidate = JSON.parse(snapshot.val());
			pc.addIceCandidate(new RTCIceCandidate(candidate));
		});
}

        roomInput.onchange = async () => {
			await init();
			const roomId = roomInput.value;
			const roomRef = db.ref(roomId);
			const calleeCandidatesRef = roomRef.child("calleeCandidates");

			pc.onicecandidate = event => {
				if (event.candidate) {
					calleeCandidatesRef.push(JSON.stringify(event.candidate));
				}
			};

			roomRef.child("offer").on("value", async snapshot => {
				if (snapshot.exists() && !pc.currentRemoteDescription) {
					const offer = JSON.parse(snapshot.val());
					await pc.setRemoteDescription(offer);
					const answer = await pc.createAnswer();
					await pc.setLocalDescription(answer);
					await roomRef.child("answer").set(JSON.stringify(answer));
				}
			});

			// Handle ICE candidates from caller
			roomRef.child("callerCandidates").on("child_added", snapshot => {
				const candidate = JSON.parse(snapshot.val());
				pc.addIceCandidate(new RTCIceCandidate(candidate));
			});
};

    </script>
</body>
</html>
